name: DJ's Docker CI/CD

on:
  push:
    branches:
      - release
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - release

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      # 步骤1：拉取仓库代码到运行环境
      - name: 拉取代码
        uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      
      # 步骤2：配置 Docker Buildx（优化构建，支持多平台可选）
      - name: 配置 Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 步骤3：登录 Docker Hub（使用 Secrets 中的凭证，避免硬编码）
      - name: 登录 Docker Hub
        id: docker_login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
        env:
          DEBUG_MODE: true  # 启用调试模式

      # 步骤4：显示登录状态
      - name: 检查登录状态
        if: always()  # 强制执行
        run: |
          echo "登录步骤状态码: ${{ steps.docker_login.outcome }}"
          echo "Docker Hub 用户名: ${{ secrets.DOCKER_HUB_USERNAME }}"
          echo "登录详细信息: ${{ steps.docker_login.outputs }}"
          echo "GitHub Runner IP: $(curl -s ifconfig.me)"
          echo "当前时间戳: $(date +%s)"